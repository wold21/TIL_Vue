<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MVCC 2부</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.1b1cc691.css" as="style"><link rel="preload" href="/assets/js/app.3d4a244f.js" as="script"><link rel="preload" href="/assets/js/2.5a32e135.js" as="script"><link rel="preload" href="/assets/js/3.aebfae9b.js" as="script"><link rel="preload" href="/assets/js/19.3a3eceec.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc83b15.js"><link rel="prefetch" href="/assets/js/11.33c10e0d.js"><link rel="prefetch" href="/assets/js/12.f786714f.js"><link rel="prefetch" href="/assets/js/13.9b126dd3.js"><link rel="prefetch" href="/assets/js/14.a7e2c688.js"><link rel="prefetch" href="/assets/js/15.25e2fd6d.js"><link rel="prefetch" href="/assets/js/16.2e656889.js"><link rel="prefetch" href="/assets/js/17.7e3b5de5.js"><link rel="prefetch" href="/assets/js/18.309da85a.js"><link rel="prefetch" href="/assets/js/20.18c8ec60.js"><link rel="prefetch" href="/assets/js/21.b24689ab.js"><link rel="prefetch" href="/assets/js/22.9c89ce63.js"><link rel="prefetch" href="/assets/js/23.79301e0f.js"><link rel="prefetch" href="/assets/js/24.3d296499.js"><link rel="prefetch" href="/assets/js/25.619476bf.js"><link rel="prefetch" href="/assets/js/26.61f50732.js"><link rel="prefetch" href="/assets/js/27.1b69d916.js"><link rel="prefetch" href="/assets/js/28.89a735d6.js"><link rel="prefetch" href="/assets/js/29.ccc8a54a.js"><link rel="prefetch" href="/assets/js/30.d49bb387.js"><link rel="prefetch" href="/assets/js/31.a19a50ca.js"><link rel="prefetch" href="/assets/js/32.76335e46.js"><link rel="prefetch" href="/assets/js/33.0ae2bfb5.js"><link rel="prefetch" href="/assets/js/34.d9ef7fa5.js"><link rel="prefetch" href="/assets/js/35.debc6a05.js"><link rel="prefetch" href="/assets/js/36.b36a476d.js"><link rel="prefetch" href="/assets/js/37.e73e7c0d.js"><link rel="prefetch" href="/assets/js/38.385ed8d9.js"><link rel="prefetch" href="/assets/js/39.4c01027a.js"><link rel="prefetch" href="/assets/js/4.f8c46463.js"><link rel="prefetch" href="/assets/js/40.c3b57856.js"><link rel="prefetch" href="/assets/js/41.f817b799.js"><link rel="prefetch" href="/assets/js/42.d49708a0.js"><link rel="prefetch" href="/assets/js/43.a8ee7d70.js"><link rel="prefetch" href="/assets/js/44.a1e601a9.js"><link rel="prefetch" href="/assets/js/45.51e3202e.js"><link rel="prefetch" href="/assets/js/46.7bca72a3.js"><link rel="prefetch" href="/assets/js/47.8fa0eb38.js"><link rel="prefetch" href="/assets/js/48.d3350cee.js"><link rel="prefetch" href="/assets/js/49.4f1950c1.js"><link rel="prefetch" href="/assets/js/5.2130f56c.js"><link rel="prefetch" href="/assets/js/50.fec7fb28.js"><link rel="prefetch" href="/assets/js/51.e5fa504c.js"><link rel="prefetch" href="/assets/js/52.4d664b62.js"><link rel="prefetch" href="/assets/js/53.74988712.js"><link rel="prefetch" href="/assets/js/54.e9d80ed6.js"><link rel="prefetch" href="/assets/js/55.164a2e7f.js"><link rel="prefetch" href="/assets/js/56.512d2576.js"><link rel="prefetch" href="/assets/js/57.fb9ac4c5.js"><link rel="prefetch" href="/assets/js/58.35b9518f.js"><link rel="prefetch" href="/assets/js/59.00b99f19.js"><link rel="prefetch" href="/assets/js/6.d38de28a.js"><link rel="prefetch" href="/assets/js/60.38a4b3d7.js"><link rel="prefetch" href="/assets/js/61.a3b39054.js"><link rel="prefetch" href="/assets/js/62.ce8b53be.js"><link rel="prefetch" href="/assets/js/63.326b967f.js"><link rel="prefetch" href="/assets/js/64.b0b43d93.js"><link rel="prefetch" href="/assets/js/65.2dfaee8f.js"><link rel="prefetch" href="/assets/js/66.937c1489.js"><link rel="prefetch" href="/assets/js/67.11f94983.js"><link rel="prefetch" href="/assets/js/68.66691571.js"><link rel="prefetch" href="/assets/js/69.b67bcb71.js"><link rel="prefetch" href="/assets/js/7.dc811ad6.js"><link rel="prefetch" href="/assets/js/70.4bb0d425.js"><link rel="prefetch" href="/assets/js/71.a711bb40.js"><link rel="prefetch" href="/assets/js/72.a00784a6.js"><link rel="prefetch" href="/assets/js/73.7baf6484.js"><link rel="prefetch" href="/assets/js/74.5f614c64.js"><link rel="prefetch" href="/assets/js/75.7adcb2c8.js"><link rel="prefetch" href="/assets/js/76.12fe6f01.js"><link rel="prefetch" href="/assets/js/77.41a3cb45.js"><link rel="prefetch" href="/assets/js/78.3681aa9e.js"><link rel="prefetch" href="/assets/js/79.8bfb4e66.js"><link rel="prefetch" href="/assets/js/8.ce67ea46.js"><link rel="prefetch" href="/assets/js/80.c8caf8e2.js"><link rel="prefetch" href="/assets/js/81.1498914c.js"><link rel="prefetch" href="/assets/js/82.d2ef4e52.js"><link rel="prefetch" href="/assets/js/83.679e6c79.js"><link rel="prefetch" href="/assets/js/84.d8c96402.js"><link rel="prefetch" href="/assets/js/85.00dbb840.js"><link rel="prefetch" href="/assets/js/86.26adffd9.js"><link rel="prefetch" href="/assets/js/9.2f95cc59.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1b1cc691.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mvcc-2부"><a href="#mvcc-2부" class="header-anchor">#</a> MVCC 2부</h1> <h2 id="개요"><a href="#개요" class="header-anchor">#</a> 개요</h2> <p>이전 예제와 동일하지만 MySQL인 경우 어떻게 해결하는지 알아보겠다.</p> <h2 id="예제"><a href="#예제" class="header-anchor">#</a> 예제</h2> <br> <img src="/assets/img/my.704b56e7.png" alt="my" height="300"> <blockquote><p>위 예제는 이전 예제의 마지막 부분을 가져온 것.</p></blockquote> <br> <img src="/assets/img/my_1.236bd59a.png" alt="my_1" height="300"> <p>MySQL에서는 lost update를 해결하기 위해서 read를 할 때에 추가적으로 lock을 줄 수 있게 해야한다. 이를 <code>Locking read</code>라고 하며 쿼리문에 <code>FOR UPDATE</code>를 추가해주면 <code>read를 하면서도 write lock을 취득</code>할 수 있게 된다. 이는 RDBMS에서 하는 것이 아니라 개발자가 직접 추가해줘야한다.</p> <br> <img src="/assets/img/my.704b56e7.png" alt="my" height="200"> <p>자 그래서 순서대로 schedule을 적어보자면</p> <ol><li>tx1의 read(x)도 locking read의 동작으로 lock을 취득하려하지만 tx2가 가지고 있기 때문에 대기하게 된다.</li> <li>x에 대해 write 권한을 가지고 있는 tx2가 x=80을 하고 저장 공간에 해당 변경 사항을 저장한다.</li> <li>그리고 tx2는 commit을 하게 되면서 lock을 반납하고 값을 최종적으로 80으로 업데이트 하게된다.</li> <li>이제 tx1이 lock을 얻게되고 x를 read하게 되는데 이때 repeatable read level임에도 불구하고 80을 읽게된다.
<ul><li>그 이유는 MySQL의 locking read는 가장 최근의 commit된 데이터를 읽는 규칙이 있기 때문이다.</li></ul></li> <li>이제 tx1은 x의 변경사항인 40을 저장한다.</li> <li>tx1은 y에 대한 read를 함과 동시에 locking read를 적용해주고 write lock을 획득한다.</li> <li>그리고 tx1은 y=50을 적용하고 변경 사항을 저장한다.</li> <li>tx1은 commit을 완료하고 모든 lock을 반환한다.</li></ol> <h3 id="locking-read"><a href="#locking-read" class="header-anchor">#</a> Locking read</h3> <p>MySQL에서는 read할 시 Lock을 취득하게 되어있는데 이때 두가지 종류로 나뉘게 된다. 이 문법은 다른 RDBMS에도 존재하지만 그 동작 방식이 조금 다른데 아래에서 설명해보겠다.</p> <h4 id="for-update"><a href="#for-update" class="header-anchor">#</a> FOR UPDATE</h4> <p>이는 write lock 즉, exclusive lock을 획득하게 되는 것을 말한다.</p> <h4 id="for-share"><a href="#for-share" class="header-anchor">#</a> FOR SHARE</h4> <p>이는 read lock 즉, shared lock을 획득하게 된다.</p> <h2 id="repeatable-read일-때-write-skew-문제"><a href="#repeatable-read일-때-write-skew-문제" class="header-anchor">#</a> repeatable read일 때 write skew 문제</h2> <br> <img src="/assets/img/write_skew.3cf19bc1.png" alt="write_skew" height="300"> <p>이러한 tx들이 있을때 x, y의 초기값은 각각 10으로 최종 기대 결과 값은 30, 20 혹은 20, 30이 나와야 정상인 값이라고 할 수 있는데 이 경우 repeatable read임에도 불구하고 결과값이 20, 20으로 도출되었다. 이를 <code>write skew</code>라고 부른다. 이 현상은 MySQL과 PostgreSQL에서도 나타날 수 있는 현상이다. 더불어 이 현상을 해결하기 위해서 isolation level을 serializable로 올려서 작업하게되면 write skew문제는 해결된다.</p> <h3 id="mysql"><a href="#mysql" class="header-anchor">#</a> MySQL</h3> <p>mysql에서는 locking read를 사용하여 해결할 수 있다. 서로 read를 할 때 write lock을 얻으려 할 것이고 먼저 lock을 얻지 못하면 기다렸다가 최종적으로 commit된 값을 기반으로 나머지 tx이 진행 될 것이기 때문에 결과값은 문제가 없게 된다.</p> <img src="/assets/img/my_skew.54d736a3.png" alt="my_skew" height="200"> <h3 id="postgresql"><a href="#postgresql" class="header-anchor">#</a> PostgreSQL</h3> <p>위 처럼 PostgreSQL 또한 locking read를 할 수 있는데 그 방식이 조금 다르다고 하였다, 한번 살펴보자.</p> <img src="/assets/img/post_skew.76f2b733.png" alt="post_skew" height="200"> <p>그러나 repeatable read인 경우 같은 데이터에 먼저 update한 tx가 commit이 되면 나중에 접근하는 tx는 rollback이 되는 규칙을 가지고 있어. 최종적인 결과값은 x=20, y=10으로 사실은 성공한 schedule이라고 볼 수 있게 되는 것이다.</p> <h3 id="isolation-level이-serializable일-때"><a href="#isolation-level이-serializable일-때" class="header-anchor">#</a> Isolation level이 serializable일 때</h3> <h4 id="mysql-2"><a href="#mysql-2" class="header-anchor">#</a> MySQL</h4> <ul><li>repeatable read와 유사</li> <li>tx의 모든 평범한 select문은 암묵적으로 <code>for share</code>처럼 동작한다.</li></ul> <h4 id="postgresql-2"><a href="#postgresql-2" class="header-anchor">#</a> PostgreSQL</h4> <ul><li>SSI(serializable snapshot isolation)로 구현</li> <li>first-committier-winner</li></ul> <h2 id="추가-전달-사항"><a href="#추가-전달-사항" class="header-anchor">#</a> 추가 전달 사항</h2> <p>MySQL과 postgreSQL은 repeatable read level에서 phantom read를 발생시키지 않습니다
표준 SQL에서는 repeatable read에서는 phantom read가 발생하는 것으로 정의하고 있는데 MySQL과 postgreSQL은 표준보다 더 엄격히 구현되어 있다.</p> <p>MySQL의 serializable level은 이전 영상에서 설명했던 SS2PL로 동작하는 것으로 판단됩니다
모든 select 문이 암묵적으로는 select ... for share로 처리되고, MySQL에서 락은 commit 혹은 rollback 될 때 반환되기 때문에 그렇다.</p> <h2 id="마무리"><a href="#마무리" class="header-anchor">#</a> 마무리</h2> <p>지금까지 DB의 트랜잭션에 대한 concurrency control 즉, 동시성에 대해 공부해보았다. 동시성과 관련이 있는 기술로 앞서 배웠던 Isolation level, Lock base 그리고 MVCC를 마지막으로 배워보았다.</p> <p>Isolation level이 등장하게 된 계기는 dirty read, non-repeatable read, phantom read와 같은 현상을 방지하기 위해서 등장했고 얼마나 엄격하게 트랜잭션을 관리할지 read uncommitted, read committed, repeatable read, serializabla로 구분짓게 되었다. 이는 트랜잭션 처리량에 영향을 미치게된다.</p> <p>그리고 Lock은 트랜잭션이 데이터에 read 혹은 write를 할 때 해당 tx만 접근 권한을 얻어 다른 tx가 접근하지 못하게 하는 것이다. read-read일때는 허용이 되지만 read-write같은 쌍은 허용하지 않는다. 이 Lock base에는 2PL protocol이 존재하고 해당 프로토콜은 lock을 얻고 반납하는 단계를 2 페이즈로 나누고 연산하는 것이 컨셉이다. 한 단계에서는 lock을 취득만 하고 다른 단계에서는 반납만 하는 방법이다. 2PL에도 종류가 있는데 tx 시작시에 모든 lock을 취득하는 방식을 conservative 2PL이라하고 write lock을 commit / rollback 될 때 반환하는 방식을 Strict 2PL (혹은 S2PL)이라고 하며 commit / rollback이 될 때 read-lock, write-lock을 모두 반납하는 String strict 2PL (혹은 SS2PL or rigorous 2PL)이라고 한다.</p> <p>마지막으로 <code>특정 시점 기준으로 커밋된 데이터</code>를 읽는 MVCC가 등장하게 된다. 이는 Isolation level에 영향을 받고 있으며 특정 시점을 관리해야하지 때문에 RDBMS가 데이터의 변화를 관리하고 있다. 그래서 lock의 단점이었던 read를 하는 도중에도 write를 할 수 있게 된다.</p> <p>이러한 강의를 들으면서 어떻게 해결해야지 이상현상이 없을까를 또 계속 생각하고 있었던 것 같다. 이 영상의 댓글을 살펴보니 postgreSQL에서 만약 first-commitier-winner에 밀려 rollback이 된다면 그냥 애러가 나는 건지에 대한 질문이 있었는데 비즈니스 로직 단에서 이런 경우 타이밍 이슈로 실패한 것이기 때문에 1~2번 더 재시도를 하게 구현하면 될 것 같다고 댓글을 달아주셨다. 사실 직접 맞닿뜨리고 해결하기 전까지는 이 모든 규칙들이 와닿지 않을 것 같다. 우리는 이미 아무 설정을 하지 않아도 일반적인 작업들은 문제없이 사용하고 있기 때문이다. 그렇지만 꼭 알아두어야할 중요한 정보라고 생각된다.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3d4a244f.js" defer></script><script src="/assets/js/2.5a32e135.js" defer></script><script src="/assets/js/3.aebfae9b.js" defer></script><script src="/assets/js/19.3a3eceec.js" defer></script>
  </body>
</html>
