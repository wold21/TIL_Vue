<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MVCC 2부 | 코드를 부르자</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="/TIL_Vue/main.css">
    <meta name="description" content="Hyuk's tech Blog">
    <meta name="last-updated" content="2025-08-06T08:50:54.969Z">
    
    <link rel="preload" href="/TIL_Vue/assets/css/0.styles.6207d2a6.css" as="style"><link rel="preload" href="/TIL_Vue/assets/js/app.680c0248.js" as="script"><link rel="preload" href="/TIL_Vue/assets/js/2.a9c8eead.js" as="script"><link rel="preload" href="/TIL_Vue/assets/js/4.011e6a29.js" as="script"><link rel="preload" href="/TIL_Vue/assets/js/19.90593d81.js" as="script"><link rel="prefetch" href="/TIL_Vue/assets/js/10.0a05a31d.js"><link rel="prefetch" href="/TIL_Vue/assets/js/11.525a8e4b.js"><link rel="prefetch" href="/TIL_Vue/assets/js/12.e9a05b20.js"><link rel="prefetch" href="/TIL_Vue/assets/js/13.ecd6f8ec.js"><link rel="prefetch" href="/TIL_Vue/assets/js/14.0117a655.js"><link rel="prefetch" href="/TIL_Vue/assets/js/15.0242e24b.js"><link rel="prefetch" href="/TIL_Vue/assets/js/16.36fac952.js"><link rel="prefetch" href="/TIL_Vue/assets/js/17.f1efbcfc.js"><link rel="prefetch" href="/TIL_Vue/assets/js/18.6cfaf4c8.js"><link rel="prefetch" href="/TIL_Vue/assets/js/20.dea50a5b.js"><link rel="prefetch" href="/TIL_Vue/assets/js/21.65afbdf8.js"><link rel="prefetch" href="/TIL_Vue/assets/js/22.24a873ca.js"><link rel="prefetch" href="/TIL_Vue/assets/js/23.37ee6a6c.js"><link rel="prefetch" href="/TIL_Vue/assets/js/24.6ed326af.js"><link rel="prefetch" href="/TIL_Vue/assets/js/25.22be073d.js"><link rel="prefetch" href="/TIL_Vue/assets/js/26.6aaf8f62.js"><link rel="prefetch" href="/TIL_Vue/assets/js/27.9ed50f77.js"><link rel="prefetch" href="/TIL_Vue/assets/js/28.88884501.js"><link rel="prefetch" href="/TIL_Vue/assets/js/29.ae50cb91.js"><link rel="prefetch" href="/TIL_Vue/assets/js/3.15a5303e.js"><link rel="prefetch" href="/TIL_Vue/assets/js/30.df7b53de.js"><link rel="prefetch" href="/TIL_Vue/assets/js/31.b31a1fcb.js"><link rel="prefetch" href="/TIL_Vue/assets/js/32.d5485ee9.js"><link rel="prefetch" href="/TIL_Vue/assets/js/33.2789796d.js"><link rel="prefetch" href="/TIL_Vue/assets/js/34.5f0e1ddc.js"><link rel="prefetch" href="/TIL_Vue/assets/js/35.966a86c6.js"><link rel="prefetch" href="/TIL_Vue/assets/js/36.20137cbf.js"><link rel="prefetch" href="/TIL_Vue/assets/js/37.d1f9a6f4.js"><link rel="prefetch" href="/TIL_Vue/assets/js/38.cb82633f.js"><link rel="prefetch" href="/TIL_Vue/assets/js/39.d14a4dd6.js"><link rel="prefetch" href="/TIL_Vue/assets/js/40.f0405875.js"><link rel="prefetch" href="/TIL_Vue/assets/js/41.31451aff.js"><link rel="prefetch" href="/TIL_Vue/assets/js/42.f0c1c96e.js"><link rel="prefetch" href="/TIL_Vue/assets/js/43.0ddd3638.js"><link rel="prefetch" href="/TIL_Vue/assets/js/44.93a44d80.js"><link rel="prefetch" href="/TIL_Vue/assets/js/45.ae44d6c8.js"><link rel="prefetch" href="/TIL_Vue/assets/js/46.55ddb165.js"><link rel="prefetch" href="/TIL_Vue/assets/js/47.b080c69a.js"><link rel="prefetch" href="/TIL_Vue/assets/js/48.208e8f24.js"><link rel="prefetch" href="/TIL_Vue/assets/js/49.0b511e7a.js"><link rel="prefetch" href="/TIL_Vue/assets/js/5.56f74a99.js"><link rel="prefetch" href="/TIL_Vue/assets/js/50.233c58e3.js"><link rel="prefetch" href="/TIL_Vue/assets/js/51.acd32246.js"><link rel="prefetch" href="/TIL_Vue/assets/js/52.e69a6fdd.js"><link rel="prefetch" href="/TIL_Vue/assets/js/53.e5e2ed96.js"><link rel="prefetch" href="/TIL_Vue/assets/js/54.b4aed006.js"><link rel="prefetch" href="/TIL_Vue/assets/js/55.50f6e2c9.js"><link rel="prefetch" href="/TIL_Vue/assets/js/56.137b59c3.js"><link rel="prefetch" href="/TIL_Vue/assets/js/57.59cefd8f.js"><link rel="prefetch" href="/TIL_Vue/assets/js/58.88f1d476.js"><link rel="prefetch" href="/TIL_Vue/assets/js/59.d0f33eb7.js"><link rel="prefetch" href="/TIL_Vue/assets/js/6.92bd9c75.js"><link rel="prefetch" href="/TIL_Vue/assets/js/60.6925a13f.js"><link rel="prefetch" href="/TIL_Vue/assets/js/61.6596d885.js"><link rel="prefetch" href="/TIL_Vue/assets/js/62.c7c48e12.js"><link rel="prefetch" href="/TIL_Vue/assets/js/63.769b425a.js"><link rel="prefetch" href="/TIL_Vue/assets/js/64.0aec254a.js"><link rel="prefetch" href="/TIL_Vue/assets/js/65.2cee85dc.js"><link rel="prefetch" href="/TIL_Vue/assets/js/66.bc258e95.js"><link rel="prefetch" href="/TIL_Vue/assets/js/67.180f6968.js"><link rel="prefetch" href="/TIL_Vue/assets/js/68.1d3351c1.js"><link rel="prefetch" href="/TIL_Vue/assets/js/69.ffaae97b.js"><link rel="prefetch" href="/TIL_Vue/assets/js/7.6854cd1d.js"><link rel="prefetch" href="/TIL_Vue/assets/js/70.441b0fe0.js"><link rel="prefetch" href="/TIL_Vue/assets/js/71.f2cd3b9a.js"><link rel="prefetch" href="/TIL_Vue/assets/js/72.e85d4d14.js"><link rel="prefetch" href="/TIL_Vue/assets/js/73.41c7c59a.js"><link rel="prefetch" href="/TIL_Vue/assets/js/74.9d446c1e.js"><link rel="prefetch" href="/TIL_Vue/assets/js/75.922a3789.js"><link rel="prefetch" href="/TIL_Vue/assets/js/76.f6988d29.js"><link rel="prefetch" href="/TIL_Vue/assets/js/77.789cd761.js"><link rel="prefetch" href="/TIL_Vue/assets/js/78.ffdbb786.js"><link rel="prefetch" href="/TIL_Vue/assets/js/79.4951902d.js"><link rel="prefetch" href="/TIL_Vue/assets/js/8.85430645.js"><link rel="prefetch" href="/TIL_Vue/assets/js/80.a6100b43.js"><link rel="prefetch" href="/TIL_Vue/assets/js/81.48f63cb5.js"><link rel="prefetch" href="/TIL_Vue/assets/js/82.a7cc5866.js"><link rel="prefetch" href="/TIL_Vue/assets/js/83.1c9143f7.js"><link rel="prefetch" href="/TIL_Vue/assets/js/84.5c3d5117.js"><link rel="prefetch" href="/TIL_Vue/assets/js/85.60c9d7f6.js"><link rel="prefetch" href="/TIL_Vue/assets/js/86.808b2828.js"><link rel="prefetch" href="/TIL_Vue/assets/js/9.e072e95c.js">
    <link rel="stylesheet" href="/TIL_Vue/assets/css/0.styles.6207d2a6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL_Vue/" class="home-link router-link-active"><img src="https://cdn.shopify.com/s/files/1/0276/4803/2851/files/10375_-_Inferno_22_09_20_122834a1-bdd3-4886-b963-b53234fc46e5_480x480.jpg?v=1604507899" alt="코드를 부르자" class="logo"> <span class="site-name can-hide">코드를 부르자</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/wold21/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://companion-tazo.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/wold21/TIL_Vue" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/wold21/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://companion-tazo.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/wold21/TIL_Vue" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🌏 Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>🛢️ Database</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Database</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL_Vue/Database/Database/intro/intro.html" class="sidebar-link">Database 시작</a></li><li><a href="/TIL_Vue/Database/Database/RelationDatabase/relation_database.html" class="sidebar-link">관계형 데이터베이스</a></li><li><a href="/TIL_Vue/Database/Database/StoreFuction/store_fuction.html" class="sidebar-link">Stored fuction</a></li><li><a href="/TIL_Vue/Database/Database/StoreProcedure/store_procedure_1.html" class="sidebar-link">Stored procedure 1부</a></li><li><a href="/TIL_Vue/Database/Database/StoreProcedure/store_procedure_2.html" class="sidebar-link">Stored procedure 2부</a></li><li><a href="/TIL_Vue/Database/Database/Trigger/trigger.html" class="sidebar-link">Trigger</a></li><li><a href="/TIL_Vue/Database/Database/DBArchitecture/db_architecture.html" class="sidebar-link">DB 설계</a></li><li><a href="/TIL_Vue/Database/Database/PartioningShardingReplication/1.html" class="sidebar-link">Partioning &amp; Sharding &amp; Replication</a></li><li><a href="/TIL_Vue/Database/Database/DBCP/dbcp.html" class="sidebar-link">DB Connection pool</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>Concurrency</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>MVCC</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL_Vue/Database/Mvcc/1/mvcc_1.html" class="sidebar-link">MVCC 1부</a></li><li><a href="/TIL_Vue/Database/Mvcc/2/mvcc_2.html" aria-current="page" class="active sidebar-link">MVCC 2부</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/TIL_Vue/Database/Mvcc/2/mvcc_2.html#개요" class="sidebar-link">개요</a></li><li class="sidebar-sub-header"><a href="/TIL_Vue/Database/Mvcc/2/mvcc_2.html#예제" class="sidebar-link">예제</a></li><li class="sidebar-sub-header"><a href="/TIL_Vue/Database/Mvcc/2/mvcc_2.html#repeatable-read일-때-write-skew-문제" class="sidebar-link">repeatable read일 때 write skew 문제</a></li><li class="sidebar-sub-header"><a href="/TIL_Vue/Database/Mvcc/2/mvcc_2.html#추가-전달-사항" class="sidebar-link">추가 전달 사항</a></li><li class="sidebar-sub-header"><a href="/TIL_Vue/Database/Mvcc/2/mvcc_2.html#마무리" class="sidebar-link">마무리</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>정규화</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>Index</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>SQL</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🕸 Web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🧩 DataStructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🦣Gradle</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🌱 Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>☕ Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🥅 JPA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🥪 JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🌊 jQuery</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>⛓ Ajax</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🍃 Thymeleaf</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🥴 Mustache</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>😖 HandleBars.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🦋 Debug</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🎡 Tech</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mvcc-2부"><a href="#mvcc-2부" class="header-anchor">#</a> MVCC 2부</h1> <h2 id="개요"><a href="#개요" class="header-anchor">#</a> 개요</h2> <p>이전 예제와 동일하지만 MySQL인 경우 어떻게 해결하는지 알아보겠다.</p> <h2 id="예제"><a href="#예제" class="header-anchor">#</a> 예제</h2> <br> <img src="/TIL_Vue/assets/img/my.704b56e7.png" alt="my" height="300"> <blockquote><p>위 예제는 이전 예제의 마지막 부분을 가져온 것.</p></blockquote> <br> <img src="/TIL_Vue/assets/img/my_1.236bd59a.png" alt="my_1" height="300"> <p>MySQL에서는 lost update를 해결하기 위해서 read를 할 때에 추가적으로 lock을 줄 수 있게 해야한다. 이를 <code>Locking read</code>라고 하며 쿼리문에 <code>FOR UPDATE</code>를 추가해주면 <code>read를 하면서도 write lock을 취득</code>할 수 있게 된다. 이는 RDBMS에서 하는 것이 아니라 개발자가 직접 추가해줘야한다.</p> <br> <img src="/TIL_Vue/assets/img/my.704b56e7.png" alt="my" height="200"> <p>자 그래서 순서대로 schedule을 적어보자면</p> <ol><li>tx1의 read(x)도 locking read의 동작으로 lock을 취득하려하지만 tx2가 가지고 있기 때문에 대기하게 된다.</li> <li>x에 대해 write 권한을 가지고 있는 tx2가 x=80을 하고 저장 공간에 해당 변경 사항을 저장한다.</li> <li>그리고 tx2는 commit을 하게 되면서 lock을 반납하고 값을 최종적으로 80으로 업데이트 하게된다.</li> <li>이제 tx1이 lock을 얻게되고 x를 read하게 되는데 이때 repeatable read level임에도 불구하고 80을 읽게된다.
<ul><li>그 이유는 MySQL의 locking read는 가장 최근의 commit된 데이터를 읽는 규칙이 있기 때문이다.</li></ul></li> <li>이제 tx1은 x의 변경사항인 40을 저장한다.</li> <li>tx1은 y에 대한 read를 함과 동시에 locking read를 적용해주고 write lock을 획득한다.</li> <li>그리고 tx1은 y=50을 적용하고 변경 사항을 저장한다.</li> <li>tx1은 commit을 완료하고 모든 lock을 반환한다.</li></ol> <h3 id="locking-read"><a href="#locking-read" class="header-anchor">#</a> Locking read</h3> <p>MySQL에서는 read할 시 Lock을 취득하게 되어있는데 이때 두가지 종류로 나뉘게 된다. 이 문법은 다른 RDBMS에도 존재하지만 그 동작 방식이 조금 다른데 아래에서 설명해보겠다.</p> <h4 id="for-update"><a href="#for-update" class="header-anchor">#</a> FOR UPDATE</h4> <p>이는 write lock 즉, exclusive lock을 획득하게 되는 것을 말한다.</p> <h4 id="for-share"><a href="#for-share" class="header-anchor">#</a> FOR SHARE</h4> <p>이는 read lock 즉, shared lock을 획득하게 된다.</p> <h2 id="repeatable-read일-때-write-skew-문제"><a href="#repeatable-read일-때-write-skew-문제" class="header-anchor">#</a> repeatable read일 때 write skew 문제</h2> <br> <img src="/TIL_Vue/assets/img/write_skew.3cf19bc1.png" alt="write_skew" height="300"> <p>이러한 tx들이 있을때 x, y의 초기값은 각각 10으로 최종 기대 결과 값은 30, 20 혹은 20, 30이 나와야 정상인 값이라고 할 수 있는데 이 경우 repeatable read임에도 불구하고 결과값이 20, 20으로 도출되었다. 이를 <code>write skew</code>라고 부른다. 이 현상은 MySQL과 PostgreSQL에서도 나타날 수 있는 현상이다. 더불어 이 현상을 해결하기 위해서 isolation level을 serializable로 올려서 작업하게되면 write skew문제는 해결된다.</p> <h3 id="mysql"><a href="#mysql" class="header-anchor">#</a> MySQL</h3> <p>mysql에서는 locking read를 사용하여 해결할 수 있다. 서로 read를 할 때 write lock을 얻으려 할 것이고 먼저 lock을 얻지 못하면 기다렸다가 최종적으로 commit된 값을 기반으로 나머지 tx이 진행 될 것이기 때문에 결과값은 문제가 없게 된다.</p> <img src="/TIL_Vue/assets/img/my_skew.54d736a3.png" alt="my_skew" height="200"> <h3 id="postgresql"><a href="#postgresql" class="header-anchor">#</a> PostgreSQL</h3> <p>위 처럼 PostgreSQL 또한 locking read를 할 수 있는데 그 방식이 조금 다르다고 하였다, 한번 살펴보자.</p> <img src="/TIL_Vue/assets/img/post_skew.76f2b733.png" alt="post_skew" height="200"> <p>그러나 repeatable read인 경우 같은 데이터에 먼저 update한 tx가 commit이 되면 나중에 접근하는 tx는 rollback이 되는 규칙을 가지고 있어. 최종적인 결과값은 x=20, y=10으로 사실은 성공한 schedule이라고 볼 수 있게 되는 것이다.</p> <h3 id="isolation-level이-serializable일-때"><a href="#isolation-level이-serializable일-때" class="header-anchor">#</a> Isolation level이 serializable일 때</h3> <h4 id="mysql-2"><a href="#mysql-2" class="header-anchor">#</a> MySQL</h4> <ul><li>repeatable read와 유사</li> <li>tx의 모든 평범한 select문은 암묵적으로 <code>for share</code>처럼 동작한다.</li></ul> <h4 id="postgresql-2"><a href="#postgresql-2" class="header-anchor">#</a> PostgreSQL</h4> <ul><li>SSI(serializable snapshot isolation)로 구현</li> <li>first-committier-winner</li></ul> <h2 id="추가-전달-사항"><a href="#추가-전달-사항" class="header-anchor">#</a> 추가 전달 사항</h2> <p>MySQL과 postgreSQL은 repeatable read level에서 phantom read를 발생시키지 않습니다
표준 SQL에서는 repeatable read에서는 phantom read가 발생하는 것으로 정의하고 있는데 MySQL과 postgreSQL은 표준보다 더 엄격히 구현되어 있다.</p> <p>MySQL의 serializable level은 이전 영상에서 설명했던 SS2PL로 동작하는 것으로 판단됩니다
모든 select 문이 암묵적으로는 select ... for share로 처리되고, MySQL에서 락은 commit 혹은 rollback 될 때 반환되기 때문에 그렇다.</p> <h2 id="마무리"><a href="#마무리" class="header-anchor">#</a> 마무리</h2> <p>지금까지 DB의 트랜잭션에 대한 concurrency control 즉, 동시성에 대해 공부해보았다. 동시성과 관련이 있는 기술로 앞서 배웠던 Isolation level, Lock base 그리고 MVCC를 마지막으로 배워보았다.</p> <p>Isolation level이 등장하게 된 계기는 dirty read, non-repeatable read, phantom read와 같은 현상을 방지하기 위해서 등장했고 얼마나 엄격하게 트랜잭션을 관리할지 read uncommitted, read committed, repeatable read, serializabla로 구분짓게 되었다. 이는 트랜잭션 처리량에 영향을 미치게된다.</p> <p>그리고 Lock은 트랜잭션이 데이터에 read 혹은 write를 할 때 해당 tx만 접근 권한을 얻어 다른 tx가 접근하지 못하게 하는 것이다. read-read일때는 허용이 되지만 read-write같은 쌍은 허용하지 않는다. 이 Lock base에는 2PL protocol이 존재하고 해당 프로토콜은 lock을 얻고 반납하는 단계를 2 페이즈로 나누고 연산하는 것이 컨셉이다. 한 단계에서는 lock을 취득만 하고 다른 단계에서는 반납만 하는 방법이다. 2PL에도 종류가 있는데 tx 시작시에 모든 lock을 취득하는 방식을 conservative 2PL이라하고 write lock을 commit / rollback 될 때 반환하는 방식을 Strict 2PL (혹은 S2PL)이라고 하며 commit / rollback이 될 때 read-lock, write-lock을 모두 반납하는 String strict 2PL (혹은 SS2PL or rigorous 2PL)이라고 한다.</p> <p>마지막으로 <code>특정 시점 기준으로 커밋된 데이터</code>를 읽는 MVCC가 등장하게 된다. 이는 Isolation level에 영향을 받고 있으며 특정 시점을 관리해야하지 때문에 RDBMS가 데이터의 변화를 관리하고 있다. 그래서 lock의 단점이었던 read를 하는 도중에도 write를 할 수 있게 된다.</p> <p>이러한 강의를 들으면서 어떻게 해결해야지 이상현상이 없을까를 또 계속 생각하고 있었던 것 같다. 이 영상의 댓글을 살펴보니 postgreSQL에서 만약 first-commitier-winner에 밀려 rollback이 된다면 그냥 애러가 나는 건지에 대한 질문이 있었는데 비즈니스 로직 단에서 이런 경우 타이밍 이슈로 실패한 것이기 때문에 1~2번 더 재시도를 하게 구현하면 될 것 같다고 댓글을 달아주셨다. 사실 직접 맞닿뜨리고 해결하기 전까지는 이 모든 규칙들이 와닿지 않을 것 같다. 우리는 이미 아무 설정을 하지 않아도 일반적인 작업들은 문제없이 사용하고 있기 때문이다. 그렇지만 꼭 알아두어야할 중요한 정보라고 생각된다.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/5/2025, 3:31:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL_Vue/Database/Mvcc/1/mvcc_1.html" class="prev">
        MVCC 1부
      </a></span> <span class="next"><a href="/TIL_Vue/Database/Database/FunctionalDependency/functional_dependency.html">
        Functional Dependency(함수 종속)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL_Vue/assets/js/app.680c0248.js" defer></script><script src="/TIL_Vue/assets/js/2.a9c8eead.js" defer></script><script src="/TIL_Vue/assets/js/4.011e6a29.js" defer></script><script src="/TIL_Vue/assets/js/19.90593d81.js" defer></script>
  </body>
</html>
