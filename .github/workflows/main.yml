name: Build and Deploy
on: [push]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout with full history
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        persist-credentials: false
      
    - name: Debug Git History
      run: |
        git config --global user.email "wold2180@gmail.com"
        git config --global user.name "wold21"
        echo "Last commit info:"
        git log -1
        echo "Git status:"
        git status
        echo "File timestamps:"
        git ls-tree -r --full-name --full-tree HEAD

    - name: Set Timezone
      run: sudo timedatectl set-timezone Asia/Seoul 

    - name: Clean Yarn Cache
      run: yarn cache clean

    - name: Delete node_modules and yarn.lock
      run: |
        rm -rf node_modules
        rm -f yarn.lock

    - name: Install Dependencies
      run: yarn install

    - name: vuepress deploy
      uses: jenkey2011/vuepress-deploy@master
      env:
        ACCESS_TOKEN: ${{ secrets.TIL_TOKEN }}
        TARGET_REPO: wold21/TIL_Vue
        BUILD_SCRIPT: yarn build
        BUILD_DIR: build/
